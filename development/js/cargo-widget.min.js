"use strict";
var _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function(t) {
        return typeof t
    }
        : function(t) {
        return t && "function" == typeof Symbol && t.constructor === Symbol && t !== Symbol.prototype ? "symbol" : typeof t
    }
    , _extends = Object.assign || function(t) {
            for (var e, n = 1; n < arguments.length; n++)
                for (var i in e = arguments[n])
                    Object.prototype.hasOwnProperty.call(e, i) && (t[i] = e[i]);
            return t
        }
    , _createClass = function() {
        function i(t, e) {
            for (var n, i = 0; i < e.length; i++)
                (n = e[i]).enumerable = n.enumerable || !1,
                    n.configurable = !0,
                "value"in n && (n.writable = !0),
                    Object.defineProperty(t, n.key, n)
        }
        return function(t, e, n) {
            return e && i(t.prototype, e),
            n && i(t, n),
                t
        }
    }();
function _classCallCheck(t, e) {
    if (!(t instanceof e))
        throw new TypeError("Cannot call a class as a function")
}
var handleResponse = function(t) {
        if (!t.ok)
            throw new Error(t.statusText);
        return t.json()
    }
    , SELECTED = "item--selected"
    , ACTIVE = "autocompleting"
    , VISIBLE = "visible"
    , ARROW_UP = 38
    , ARROW_DOWN = 40
    , ENTER = 13
    , defaultOptions = {
        minCharacters: 2,
        fetchDelay: 0,
        inputClassName: "input",
        autoCompleteBaseClass: "autocomplete",
        url: null
    }
    , AutoComplete = function() {
        function i(t, e) {
            if (_classCallCheck(this, i),
                    !e.url)
                throw new Error("Autocomplete url is mendatory");
            this._options = _extends({}, defaultOptions, e),
                this.element = t,
                this.timeout = 0,
                this.itemsList = "",
                this.items = [],
                this.selectedIndex = -1,
                this.isOpen = !1,
                this._load()
        }
        return i.getQueryIndexes = function(t, e) {
            for (var n = new RegExp(e,"g"), i = [], o = void 0; o = n.exec(t); )
                i.push(o.index);
            return i
        }
            ,
            i.prototype._load = function() {
                this._createContainer(),
                    this._addEventListeners(),
                    this.element.setAttribute("autocomplete", "off")
            }
            ,
            i.prototype._addEventListeners = function() {
                var e = this;
                this.element.addEventListener("input", function(t) {
                    return e._onInput(t)
                }),
                    this.element.addEventListener("click", function(t) {
                        return e._onFocus(t)
                    }),
                    this.element.addEventListener("blur", function(t) {
                        return e._onBlur(t)
                    }),
                    this.element.addEventListener("focus", function(t) {
                        return e._onFocus(t)
                    }),
                    this.element.addEventListener("keyup", function(t) {
                        return e._onKeyup(t)
                    }),
                    this.container.addEventListener("click", function(t) {
                        return e._onClick(t)
                    })
            }
            ,
            i.prototype._createContainer = function() {
                this.container = document.createElement("div"),
                    this.container.className = this._options.autoCompleteBaseClass,
                    this.element.parentNode.appendChild(this.container)
            }
            ,
            i.prototype._onKeyup = function(t) {
                var e = t.keyCode
                    , n = e === ARROW_UP || e === ARROW_DOWN;
                if (!this.isOpen && this.items.length && n && (this._render(this.itemsList),
                        this.isOpen = !0),
                    n && this.isOpen) {
                    var i = e === ARROW_UP ? "up" : "down";
                    this._changeSelected(i)
                }
                e === ENTER && this.isOpen && (this._useSelected(),
                    this._onBlur())
            }
            ,
            i.prototype._onBlur = function() {
                var t = this;
                setTimeout(function() {
                    t._render(""),
                        t.isOpen = !1,
                        t.selectedIndex = -1,
                        t.element.classList.remove(t.autoCompletingClassName)
                }, 150)
            }
            ,
            i.prototype._onFocus = function() {
                this.items.length && !this.isOpen && (this._render(this.itemsList),
                    this.isOpen = !0,
                    this.element.classList.add(this.autoCompletingClassName))
            }
            ,
            i.prototype._onInput = function(t) {
                var e = this;
                clearTimeout(this.timeout),
                    this.value = t.target.value,
                    this.timeout = setTimeout(function() {
                        e._fetchItems(e.value).then(e._createAutoComplete.bind(e)).then(e._render.bind(e))
                    }, this.delay)
            }
            ,
            i.prototype._onClick = function(t) {
                t.target.classList.contains(this.baseClassName + "__item") && this._useSelected(t.target)
            }
            ,
            i.prototype._fetchItems = function(t) {
                return t.length >= this.minCharacters ? window.fetch(this._getUrl(t), {
                    method: "GET",
                    credentials: "same-origin",
                    "Content-Type": "application/json"
                }).then(handleResponse).catch(function(t) {
                    return console.error(t.response)
                }) : Promise.resolve(!1)
            }
            ,
            i.prototype._createAutoComplete = function(t) {
                return t ? (this.items = t,
                    this.selectedIndex = -1,
                    this.itemsList = this._getRenderList(this.items, this.value),
                    this.isOpen = !0,
                    this.element.classList.add(this.autoCompletingClassName)) : (this.items = [],
                    this.itemsList = ""),
                    this.itemsList
            }
            ,
            i.prototype._changeSelected = function(t) {
                var e = 0 < this.selectedIndex
                    , n = this.selectedIndex < this.items.length - 1
                    , i = this.selectedIndex;
                "up" === t && e ? i-- : "down" == t && n && i++,
                    this._setSelected(i)
            }
            ,
            i.prototype._setSelected = function(t) {
                var e = Array.from(this.container.querySelectorAll("." + this.baseClassName + "__item"));
                -1 < this.selectedIndex && e[this.selectedIndex].classList.remove(this.selectedClassName),
                    e[t].classList.add(this.selectedClassName),
                    this.selectedIndex = t
            }
            ,
            i.prototype._useSelected = function(t) {
                var e = t || this.container.querySelector("." + this.selectedClassName);
                this.element.value = e.getAttribute("data-autocomplete-value")
            }
            ,
            i.prototype._getRenderList = function(t, n) {
                var i = this
                    , e = t.map(function(t, e) {
                        return i._getRenderListItem(t, e, n)
                    });
                return '\n            <ul class="' + this.baseClassName + '__list">\n                ' + e.join("\n") + "\n            </ul>"
            }
            ,
            i.prototype._getRenderListItem = function(o, t, s) {
                var e = t === this.selectedIndex ? " " + this.selectedClassName : ""
                    , r = i.getQueryIndexes(o, s)
                    , a = this.baseClassName + "__highlight"
                    , l = r.length ? "" : o;
                r.length && r.reduce(function(t, e, n) {
                    var i = r[n + 1] ? r[n + 1] : o.length;
                    return l += "\n\t\t\t\t\t" + o.slice(t, e) + '\n\t\t\t\t\t<span class="' + a + '">' + o.slice(e, e + s.length) + "</span>\n\t\t\t\t\t" + o.slice(e + s.length, i) + "\n                ",
                        i
                }, 0);
                var n = l.replace(/\t/g, "").replace(/\n/g, "");
                return '<li class="' + this.baseClassName + "__item" + e + '" data-autocomplete-value="' + o + '">' + n + "</li>"
            }
            ,
            i.prototype._render = function(t) {
                var e = "" === t ? "remove" : "add";
                this.container.innerHTML = t,
                    this.container.classList[e](this._options.autoCompleteBaseClass + "--" + VISIBLE)
            }
            ,
            i.prototype._getUrl = function(t) {
                return this._options.url + "?query=" + t
            }
            ,
            _createClass(i, [{
                key: "minCharacters",
                get: function() {
                    return this._options.minCharacters
                }
            }, {
                key: "delay",
                get: function() {
                    return this._options.fetchDelay
                }
            }, {
                key: "baseClassName",
                get: function() {
                    return this._options.autoCompleteBaseClass
                }
            }, {
                key: "selectedClassName",
                get: function() {
                    return this.baseClassName + "__" + SELECTED
                }
            }, {
                key: "autoCompletingClassName",
                get: function() {
                    return this._options.inputClassName + "--" + ACTIVE
                }
            }]),
            i
    }();
function _classCallCheck(t, e) {
    if (!(t instanceof e))
        throw new TypeError("Cannot call a class as a function")
}
var Component = function() {
    function n(t, e) {
        _classCallCheck(this, n),
            this.scope = e,
            this.widget = t,
            this._name = this.constructor.name
    }
    return n.prototype.load = function() {
        this.widget.wrapper.innerHTML = this.render(),
            this.afterRender(),
            this.widget._component = this
    }
        ,
        n.prototype.remove = function() {
            this.widget.wrapper.innerHTML = ""
        }
        ,
        n
}();
function _defaults(t, e) {
    for (var n = Object.getOwnPropertyNames(e), i = 0; i < n.length; i++) {
        var o = n[i]
            , s = Object.getOwnPropertyDescriptor(e, o);
        s && s.configurable && void 0 === t[o] && Object.defineProperty(t, o, s)
    }
    return t
}
function _classCallCheck(t, e) {
    if (!(t instanceof e))
        throw new TypeError("Cannot call a class as a function")
}
function _possibleConstructorReturn(t, e) {
    if (!t)
        throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
    return !e || "object" !== (void 0 === e ? "undefined" : _typeof(e)) && "function" != typeof e ? t : e
}
function _inherits(t, e) {
    if ("function" != typeof e && null !== e)
        throw new TypeError("Super expression must either be null or a function, not " + (void 0 === e ? "undefined" : _typeof(e)));
    t.prototype = Object.create(e && e.prototype, {
        constructor: {
            value: t,
            enumerable: !1,
            writable: !0,
            configurable: !0
        }
    }),
    e && (Object.setPrototypeOf ? Object.setPrototypeOf(t, e) : _defaults(t, e))
}
var Index = function(t) {
    function e() {
        return _classCallCheck(this, e),
            _possibleConstructorReturn(this, t.apply(this, arguments))
    }
    return _inherits(e, t),
        e.prototype.afterRender = function() {
            var t = this;
            document.getElementById("test_btn").addEventListener("click", function() {
                new List(t.widget,{
                    title: "Component: list component"
                }).load()
            }),
                document.getElementById("remove_component").addEventListener("click", function() {
                    t.remove()
                }),
                document.getElementById("change_lang").addEventListener("click", function() {
                    t.widget.language = "ru" === t.widget.language ? "en" : "ru",
                        t.widget._component.load()
                }),
                new AutoComplete(document.getElementById("widget_city_input"),{
                    url: this.widget.getFileUrl("autocomplete.json"),
                    minCharacters: 1
                })
        }
        ,
        e.prototype.render = function() {
            return '\n                <div class="widget_home">\n                    <div class="widget_head">\n                        <h1>Component: ' + this._name + '</h1>\n                        <img src="' + this.scope.logo + '" alt="" class="logo">\n                    </div>\n                    <div class="widget_content">\n                        <input id="widget_city_input" type="text" placeholder="' + this.widget.getString("text_city") + '">\n                    </div>\n                    <button id="test_btn">Move to List component</button><br>\n                    <button id="remove_component">remove Component</button><br>\n                    <button id="change_lang">Current language: ' + this.widget.language + "</button>\n                </div>\n            "
        }
        ,
        e
}(Component);
function _defaults(t, e) {
    for (var n = Object.getOwnPropertyNames(e), i = 0; i < n.length; i++) {
        var o = n[i]
            , s = Object.getOwnPropertyDescriptor(e, o);
        s && s.configurable && void 0 === t[o] && Object.defineProperty(t, o, s)
    }
    return t
}
function _classCallCheck(t, e) {
    if (!(t instanceof e))
        throw new TypeError("Cannot call a class as a function")
}
function _possibleConstructorReturn(t, e) {
    if (!t)
        throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
    return !e || "object" !== (void 0 === e ? "undefined" : _typeof(e)) && "function" != typeof e ? t : e
}
function _inherits(t, e) {
    if ("function" != typeof e && null !== e)
        throw new TypeError("Super expression must either be null or a function, not " + (void 0 === e ? "undefined" : _typeof(e)));
    t.prototype = Object.create(e && e.prototype, {
        constructor: {
            value: t,
            enumerable: !1,
            writable: !0,
            configurable: !0
        }
    }),
    e && (Object.setPrototypeOf ? Object.setPrototypeOf(t, e) : _defaults(t, e))
}
var List = function(t) {
    function e() {
        return _classCallCheck(this, e),
            _possibleConstructorReturn(this, t.apply(this, arguments))
    }
    return _inherits(e, t),
        e.prototype.afterRender = function() {
            var t = this;
            document.getElementById("remove_component").addEventListener("click", function() {
                t.remove()
            }),
                document.getElementById("back_to_index_component").addEventListener("click", function() {
                    new Index(t.widget,{}).load()
                }),
                console.log(t.widget._component.scope)
        }
        ,
        e.prototype.render = function() {
            return '\n            \n            <div class="widget_home">\n                <div class="widget_head">\n                    <h1>Component: ' + this._name + '</h1>\n                    <img src="' + this.scope.logo + '" alt="" class="logo">\n                </div>\n                <div class="widget_content">\n                    <ul>\n                    <li>list item 1</li>\n                    <li>list item 2</li>\n                    <li>list item 3</li>\n                    <li>list item 4</li>\n                    <li>list item 5</li>\n                    </ul>\n                    <button id="remove_component">remove Component</button>\n                    <button id="back_to_index_component">back to index Component</button>\n                </div>\n            </div>   \n        '
        }
        ,
        e
}(Component);
_extends = Object.assign || function(t) {
    for (var e, n = 1; n < arguments.length; n++)
        for (var i in e = arguments[n])
            Object.prototype.hasOwnProperty.call(e, i) && (t[i] = e[i]);
    return t
}
;
function _classCallCheck(t, e) {
    if (!(t instanceof e))
        throw new TypeError("Cannot call a class as a function")
}
var CargoWidget = function() {
        var t = 0 < arguments.length && void 0 !== arguments[0] ? arguments[0] : {}
            , e = new Widget(_extends({
                width: 200,
                height: 200,
                widgetId: "cargo_widget",
                callback: function() {}
            }, t));
        e.body = document.querySelector("body"),
            e.beforeInit().then(function() {
                e.init()
            })
    }
    , Widget = function() {
        function e(t) {
            _classCallCheck(this, e),
                this.options = t,
                this.options.widgetId = t.widgetId + "_" + Math.random().toString(36).substring(7),
                this.wrapper = document.getElementById(this.options.widgetId) ? document.getElementById(this.options.widgetId) : document.createElement("div"),
                this.translation = {},
                this._component = {},
                this.options.assetsPath = "http://localhost:3000/widget/build/",
                this.language = "ru"
        }
        return e.prototype.getFileUrl = function() {
            var t = 0 < arguments.length && void 0 !== arguments[0] ? arguments[0] : "";
            return t ? this.options.assetsPath + t : ""
        }
            ,
            e.prototype.getString = function() {
                var t = 0 < arguments.length && void 0 !== arguments[0] ? arguments[0] : "";
                return this.translation && this.translation[this.language] && this.translation[this.language][t] && (t = this.translation[this.language][t]),
                    t
            }
            ,
            e.prototype.beforeInit = function() {
                var i = this;
                return new Promise(function(e) {
                        var t = document.getElementById(i.options.widgetId)
                            , n = document.getElementById(i.options.widgetId + "_css");
                        null !== t && t.remove(),
                        null !== n && n.remove(),
                            i.request({
                                url: i.getFileUrl("translation.json")
                            }).then(function(t) {
                                i.translation = JSON.parse(t),
                                    e()
                            })
                    }
                )
            }
            ,
            e.prototype.init = function() {
                var e = this;
                this.renderBefore(),
                    this.request({
                        url: "https://api9.cargo.guru/3/show_user.php",
                        method: "POST",
                        headers: {
                            "API-KEY": "RN42O4ntxJJen8GBixIf5BGCMPwwie",
                            "SESSION-STRING": "AIQEkD1MGteijnO5arRXvwsw4jcBvVkWs4PDktw0IofC1aKf5TSMFm2jCbAlZ0KYXx1ewxa5cvlvUeFzyCubj0WlfrIQZN9U0gyd1EI8acefB0dCwU7pUseryQXY32XLdPClOfRuahGvOv00DNTHsR4eLisygn14JCqDRXXpZ0oDfTmYVKutduG7XUvU8vn2DhqFjt8ztrC2uDy7SLM6OsCqbKAadKescbwhI293L9xMKU0MYBIL70lyH1"
                        },
                        body: JSON.stringify({
                            data: {
                                id: 15
                            }
                        })
                    }).then(function(t) {
                        e.options.callback(JSON.parse(t))
                    }).catch(function(t) {
                        console.log(t)
                    })
            }
            ,
            e.prototype.renderHTML = function() {
                var t = this.wrapper;
                t.setAttribute("id", this.options.widgetId),
                    t.setAttribute("class", "cargo_widget_wrapper"),
                    t.style.width = this.options.width + "px",
                    t.style.height = this.options.height + "px",
                    this.body.appendChild(t),
                    new Index(this,{
                        logo: this.getFileUrl("img/logo.png")
                    }).load()
            }
            ,
            e.prototype.renderBefore = function() {
                var t = document.createElement("link");
                t.setAttribute("id", this.options.widgetId + "_css"),
                    t.setAttribute("rel", "stylesheet"),
                    t.setAttribute("href", this.getFileUrl("cargo-widget.css")),
                    this.body.appendChild(t),
                    t.addEventListener("load", this.renderHTML())
            }
            ,
            e.prototype.request = function(i) {
                return new Promise(function(t, e) {
                        var n = new XMLHttpRequest;
                        n.open(i.method || "GET", i.url),
                        i.headers && Object.keys(i.headers).forEach(function(t) {
                            n.setRequestHeader(t, i.headers[t])
                        }),
                            n.onload = function() {
                                200 <= n.status && n.status < 300 ? t(n.response) : e(n.statusText)
                            }
                            ,
                            n.onerror = function() {
                                return e(n.statusText)
                            }
                            ,
                            n.send(i.body)
                    }
                )
            }
            ,
            e
    }();
new CargoWidget({
    width: 300,
    height: 300,
    widgetId: "my_test_widget",
    callback: function() {}
});
